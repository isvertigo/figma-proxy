<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma API Proxy v3.0.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .status {
            font-size: 1.2rem;
            margin: 1rem 0;
        }
        .version {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .spinning {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Figma API Proxy</h1>
        <div class="version">v3.0.0-enhanced</div>
        <div id="status" class="status">
            <span class="spinning">⚙️</span> 正在初始化代理服务...
        </div>
    </div>

    <script>
        console.log('🚀 API代理v3.0.0已加载');

        // 增强的代理服务列表 - 移除失败的代理，保留成功的
        const ENHANCED_PROXY_SERVICES = [
            'https://proxy.cors.sh/',
            'https://cors.bridged.cc/',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        let requestQueue = [];
        let isProcessing = false;

        // 更新状态显示
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            if (isError) {
                statusEl.innerHTML = `❌ ${message}`;
                statusEl.style.color = '#ff6b6b';
            } else {
                statusEl.innerHTML = `✅ ${message}`;
                statusEl.style.color = '#51cf66';
            }
        }

        // 增强的代理请求函数
        async function makeEnhancedProxyRequest(config) {
            const { apiUrl, headers, body, method = 'POST' } = config;
            
            console.log('🔄 开始增强代理请求:', { url: apiUrl, method });

            for (let i = 0; i < ENHANCED_PROXY_SERVICES.length; i++) {
                const proxyService = ENHANCED_PROXY_SERVICES[i];
                const serviceName = new URL(proxyService).hostname;
                
                try {
                    console.log(`📡 尝试代理 ${i + 1}/${ENHANCED_PROXY_SERVICES.length}: ${serviceName}`);
                    updateStatus(`尝试代理: ${serviceName}`);

                    let proxyUrl, requestConfig;

                    if (proxyService.includes('codetabs.com')) {
                        // CodeTabs 代理 - 需要特殊的POST处理
                        proxyUrl = `${proxyService}${encodeURIComponent(apiUrl)}`;
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                method: method,
                                headers: headers,
                                body: body
                            })
                        };
                    } else {
                        // 标准代理
                        proxyUrl = `${proxyService}${apiUrl}`;
                        requestConfig = {
                            method: method,
                            headers: {
                                ...headers,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: method === 'POST' ? JSON.stringify(body) : undefined
                        };
                    }

                    const response = await fetch(proxyUrl, requestConfig);
                    
                    if (response.ok) {
                        let responseData;
                        
                        if (proxyService.includes('codetabs.com')) {
                            // CodeTabs可能需要特殊处理
                            try {
                                responseData = await response.json();
                            } catch (parseError) {
                                console.warn('⚠️ CodeTabs响应解析失败:', parseError);
                                const text = await response.text();
                                responseData = JSON.parse(text);
                            }
                        } else {
                            responseData = await response.json();
                        }
                        
                        console.log(`✅ ${serviceName} 代理成功!`);
                        updateStatus(`代理成功: ${serviceName}`);
                        
                        return {
                            success: true,
                            data: responseData,
                            proxyUsed: serviceName
                        };
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.warn(`⚠️ ${serviceName} 代理失败:`, error.message);
                    
                    // 如果不是最后一个代理，继续尝试
                    if (i < ENHANCED_PROXY_SERVICES.length - 1) {
                        continue;
                    }
                }
            }
            
            // 所有代理都失败了
            const errorMsg = '所有增强代理服务都不可用';
            console.error(`❌ ${errorMsg}`);
            updateStatus(errorMsg, true);
            
            return {
                success: false,
                error: errorMsg
            };
        }

        // 处理队列中的请求
        async function processRequestQueue() {
            if (isProcessing || requestQueue.length === 0) return;
            
            isProcessing = true;
            
            while (requestQueue.length > 0) {
                const { config, resolve } = requestQueue.shift();
                
                try {
                    const result = await makeEnhancedProxyRequest(config);
                    resolve(result);
                } catch (error) {
                    resolve({
                        success: false,
                        error: error.message
                    });
                }
                
                // 添加延迟以避免请求过于频繁
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            isProcessing = false;
        }

        // 监听来自父页面的消息
        window.addEventListener('message', async (event) => {
            console.log('📨 收到消息v3.0.0:', event.data);
            
            if (event.data.type === 'API_REQUEST') {
                const { apiUrl, headers, body } = event.data;
                
                // 添加到请求队列
                const requestPromise = new Promise((resolve) => {
                    requestQueue.push({
                        config: { apiUrl, headers, body },
                        resolve
                    });
                });
                
                // 开始处理队列
                processRequestQueue();
                
                try {
                    const result = await requestPromise;
                    
                    // 发送响应回父页面
                    parent.postMessage({
                        type: 'API_RESPONSE',
                        success: result.success,
                        data: result.data,
                        error: result.error,
                        proxyUsed: result.proxyUsed
                    }, '*');
                    
                } catch (error) {
                    parent.postMessage({
                        type: 'API_RESPONSE',
                        success: false,
                        error: error.message
                    }, '*');
                }
            }
        });

        // 初始化完成
        setTimeout(() => {
            updateStatus('代理服务已就绪');
            console.log('✅ API代理v3.0.0准备就绪');
            
            // 通知父页面代理已准备就绪
            parent.postMessage({
                type: 'PROXY_READY',
                version: '3.0.0'
            }, '*');
        }, 1000);

        // 定期清理状态
        setInterval(() => {
            if (requestQueue.length === 0 && !isProcessing) {
                updateStatus('代理服务已就绪');
            }
        }, 5000);

    </script>
</body>
</html> 
