<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma API Proxy v3.0.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .status {
            font-size: 1.2rem;
            margin: 1rem 0;
        }
        .version {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .spinning {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Figma API Proxy</h1>
        <div class="version">v3.0.0-enhanced</div>
        <div id="status" class="status">
            <span class="spinning">âš™ï¸</span> æ­£åœ¨åˆå§‹åŒ–ä»£ç†æœåŠ¡...
        </div>
    </div>

    <script>
        console.log('ğŸš€ APIä»£ç†v3.0.0å·²åŠ è½½');

        // å¢å¼ºçš„ä»£ç†æœåŠ¡åˆ—è¡¨ - ç§»é™¤å¤±è´¥çš„ä»£ç†ï¼Œä¿ç•™æˆåŠŸçš„
        const ENHANCED_PROXY_SERVICES = [
            'https://proxy.cors.sh/',
            'https://cors.bridged.cc/',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        let requestQueue = [];
        let isProcessing = false;

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            if (isError) {
                statusEl.innerHTML = `âŒ ${message}`;
                statusEl.style.color = '#ff6b6b';
            } else {
                statusEl.innerHTML = `âœ… ${message}`;
                statusEl.style.color = '#51cf66';
            }
        }

        // å¢å¼ºçš„ä»£ç†è¯·æ±‚å‡½æ•°
        async function makeEnhancedProxyRequest(config) {
            const { apiUrl, headers, body, method = 'POST' } = config;
            
            console.log('ğŸ”„ å¼€å§‹å¢å¼ºä»£ç†è¯·æ±‚:', { url: apiUrl, method });

            for (let i = 0; i < ENHANCED_PROXY_SERVICES.length; i++) {
                const proxyService = ENHANCED_PROXY_SERVICES[i];
                const serviceName = new URL(proxyService).hostname;
                
                try {
                    console.log(`ğŸ“¡ å°è¯•ä»£ç† ${i + 1}/${ENHANCED_PROXY_SERVICES.length}: ${serviceName}`);
                    updateStatus(`å°è¯•ä»£ç†: ${serviceName}`);

                    let proxyUrl, requestConfig;

                    if (proxyService.includes('codetabs.com')) {
                        // CodeTabs ä»£ç† - éœ€è¦ç‰¹æ®Šçš„POSTå¤„ç†
                        proxyUrl = `${proxyService}${encodeURIComponent(apiUrl)}`;
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                method: method,
                                headers: headers,
                                body: body
                            })
                        };
                    } else {
                        // æ ‡å‡†ä»£ç†
                        proxyUrl = `${proxyService}${apiUrl}`;
                        requestConfig = {
                            method: method,
                            headers: {
                                ...headers,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: method === 'POST' ? JSON.stringify(body) : undefined
                        };
                    }

                    const response = await fetch(proxyUrl, requestConfig);
                    
                    if (response.ok) {
                        let responseData;
                        
                        if (proxyService.includes('codetabs.com')) {
                            // CodeTabså¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
                            try {
                                responseData = await response.json();
                            } catch (parseError) {
                                console.warn('âš ï¸ CodeTabså“åº”è§£æå¤±è´¥:', parseError);
                                const text = await response.text();
                                responseData = JSON.parse(text);
                            }
                        } else {
                            responseData = await response.json();
                        }
                        
                        console.log(`âœ… ${serviceName} ä»£ç†æˆåŠŸ!`);
                        updateStatus(`ä»£ç†æˆåŠŸ: ${serviceName}`);
                        
                        return {
                            success: true,
                            data: responseData,
                            proxyUsed: serviceName
                        };
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.warn(`âš ï¸ ${serviceName} ä»£ç†å¤±è´¥:`, error.message);
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªä»£ç†ï¼Œç»§ç»­å°è¯•
                    if (i < ENHANCED_PROXY_SERVICES.length - 1) {
                        continue;
                    }
                }
            }
            
            // æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥äº†
            const errorMsg = 'æ‰€æœ‰å¢å¼ºä»£ç†æœåŠ¡éƒ½ä¸å¯ç”¨';
            console.error(`âŒ ${errorMsg}`);
            updateStatus(errorMsg, true);
            
            return {
                success: false,
                error: errorMsg
            };
        }

        // å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
        async function processRequestQueue() {
            if (isProcessing || requestQueue.length === 0) return;
            
            isProcessing = true;
            
            while (requestQueue.length > 0) {
                const { config, resolve } = requestQueue.shift();
                
                try {
                    const result = await makeEnhancedProxyRequest(config);
                    resolve(result);
                } catch (error) {
                    resolve({
                        success: false,
                        error: error.message
                    });
                }
                
                // æ·»åŠ å»¶è¿Ÿä»¥é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            isProcessing = false;
        }

        // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', async (event) => {
            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯v3.0.0:', event.data);
            
            if (event.data.type === 'API_REQUEST') {
                const { apiUrl, headers, body } = event.data;
                
                // æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ—
                const requestPromise = new Promise((resolve) => {
                    requestQueue.push({
                        config: { apiUrl, headers, body },
                        resolve
                    });
                });
                
                // å¼€å§‹å¤„ç†é˜Ÿåˆ—
                processRequestQueue();
                
                try {
                    const result = await requestPromise;
                    
                    // å‘é€å“åº”å›çˆ¶é¡µé¢
                    parent.postMessage({
                        type: 'API_RESPONSE',
                        success: result.success,
                        data: result.data,
                        error: result.error,
                        proxyUsed: result.proxyUsed
                    }, '*');
                    
                } catch (error) {
                    parent.postMessage({
                        type: 'API_RESPONSE',
                        success: false,
                        error: error.message
                    }, '*');
                }
            }
        });

        // åˆå§‹åŒ–å®Œæˆ
        setTimeout(() => {
            updateStatus('ä»£ç†æœåŠ¡å·²å°±ç»ª');
            console.log('âœ… APIä»£ç†v3.0.0å‡†å¤‡å°±ç»ª');
            
            // é€šçŸ¥çˆ¶é¡µé¢ä»£ç†å·²å‡†å¤‡å°±ç»ª
            parent.postMessage({
                type: 'PROXY_READY',
                version: '3.0.0'
            }, '*');
        }, 1000);

        // å®šæœŸæ¸…ç†çŠ¶æ€
        setInterval(() => {
            if (requestQueue.length === 0 && !isProcessing) {
                updateStatus('ä»£ç†æœåŠ¡å·²å°±ç»ª');
            }
        }, 5000);

    </script>
</body>
</html> 
