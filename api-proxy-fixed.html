<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Figma API Proxy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .version {
            font-size: 1.2em;
            opacity: 0.8;
            margin: 10px 0;
        }
        
        .status {
            display: inline-block;
            background: #4ade80;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .info-section {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #4ade80;
        }
        
        .info-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4ade80;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .logs {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8em;
            margin-top: 15px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }

        .log-time {
            color: #94a3b8;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #f87171;
        }

        .log-info {
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸš€ Figma API Proxy</h1>
            <div class="version">v3.3.0-origin-fixed</div>
            <div class="status">âœ… ä»£ç†æœåŠ¡å·²å°±ç»ª</div>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ“¡ ä»£ç†æœåŠ¡å¯åŠ¨ä¸­...</div>
            <div id="startup-logs">
                <div>âœ… PostMessageç›‘å¬å™¨å·²æ³¨å†Œ</div>
                <div>ğŸ”— CORSç»•è¿‡ä»£ç†å·²å°±ç»ª</div>
                <div>â³ ç­‰å¾…APIè¯·æ±‚...</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="total-requests">0</div>
                <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="success-requests">0</div>
                <div class="stat-label">æˆåŠŸè¯·æ±‚</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="failed-requests">0</div>
                <div class="stat-label">å¤±è´¥è¯·æ±‚</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="uptime">0s</div>
                <div class="stat-label">è¿è¡Œæ—¶é—´</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        // ç»Ÿè®¡æ•°æ®
        let stats = {
            total: 0,
            success: 0,
            failed: 0,
            startTime: Date.now()
        };

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            document.getElementById('total-requests').textContent = stats.total;
            document.getElementById('success-requests').textContent = stats.success;
            document.getElementById('failed-requests').textContent = stats.failed;
            
            const uptime = Math.floor((Date.now() - stats.startTime) / 1000);
            document.getElementById('uptime').textContent = uptime + 's';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // å¯åŠ¨æ—¶é—´è®¡æ—¶å™¨
        setInterval(updateStats, 1000);

        // å¯åŠ¨æ—¥å¿—
        addLog('ğŸ“¡ PostMessageç›‘å¬å™¨å·²æ³¨å†Œ', 'success');
        addLog('ğŸ”— CORSç»•è¿‡ä»£ç†å·²å°±ç»ª', 'success');
        addLog('â³ ç­‰å¾…APIè¯·æ±‚...', 'info');
        addLog('ğŸš€ ä»£ç†æœåŠ¡å®Œå…¨å°±ç»ªï¼Œç­‰å¾…iframeé€šä¿¡', 'success');

        // PostMessageç›‘å¬å™¨ - ä¿®å¤åçš„ç‰ˆæœ¬
        window.addEventListener('message', async function(event) {
            // ä¿®å¤ï¼šå…è®¸æ¥è‡ªFigmaå’Œè‡ªå·±åŸŸåçš„æ¶ˆæ¯
            const allowedOrigins = [
                'https://www.figma.com',
                'https://figma.com', 
                'https://isvertigo.github.io'  // å…è®¸è‡ªå·±åŸŸåçš„iframeæ¶ˆæ¯
            ];
            
            const isAllowedOrigin = allowedOrigins.some(origin => 
                event.origin === origin || event.origin.endsWith('.figma.com')
            );
            
            if (!isAllowedOrigin) {
                addLog(`âŒ æ‹’ç»æ¥è‡ª ${event.origin} çš„è¯·æ±‚`, 'error');
                return;
            }

            addLog(`âœ… æ¥å—æ¥è‡ª ${event.origin} çš„æ¶ˆæ¯`, 'info');

            const message = event.data;
            
            if (message && message.type === 'api-proxy-request') {
                stats.total++;
                updateStats();
                
                addLog(`ğŸ“¨ æ”¶åˆ°APIè¯·æ±‚: ${message.requestId}`, 'info');
                addLog(`ğŸ¯ ç›®æ ‡: ${message.apiUrl}`, 'info');
                
                try {
                    // ä½¿ç”¨ä¼ ç»ŸCORSä»£ç†ç»•è¿‡é™åˆ¶
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                    const response = await fetch(proxyUrl + message.apiUrl, {
                        method: message.method || 'POST',
                        headers: {
                            ...message.headers,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: typeof message.body === 'string' ? message.body : JSON.stringify(message.body)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        stats.success++;
                        
                        addLog(`âœ… è¯·æ±‚æˆåŠŸ: ${message.requestId}`, 'success');
                        
                        // å‘é€æˆåŠŸå“åº” - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„origin
                        event.source.postMessage({
                            type: 'api-proxy-response',
                            requestId: message.requestId,
                            success: true,
                            data: data,
                            status: response.status
                        }, event.origin);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    stats.failed++;
                    
                    addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                    
                    // å‘é€é”™è¯¯å“åº” - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„origin
                    event.source.postMessage({
                        type: 'api-proxy-response',
                        requestId: message.requestId,
                        success: false,
                        error: error.message
                    }, event.origin);
                }
                
                updateStats();
            }
        }, false);

        addLog('ğŸ‘‚ å¼€å§‹ç›‘å¬æ¥è‡ªFigmaçš„æ¶ˆæ¯...', 'info');
    </script>
</body>
</html>
