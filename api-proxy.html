<!DOCTYPE html>
<html>
<head>
    <title>Figma Plugin API Proxy</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f0f0f0;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨å¤„ç†APIè¯·æ±‚...</p>
    </div>

    <script>
        console.log('ğŸŒ APIä»£ç†é¡µé¢å·²åŠ è½½');
        
        // å®šä¹‰å¤šä¸ªCORSä»£ç†ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
        const CORS_PROXIES = [
            {
                name: 'proxy.cors.sh',
                url: 'https://proxy.cors.sh/',
                headers: {}
            },
            {
                name: 'cors.bridged.cc', 
                url: 'https://cors.bridged.cc/',
                headers: {}
            },
            {
                name: 'corsfix.com',
                url: 'https://api.corsfix.com/',
                headers: {
                    'X-Cors-Api-Key': 'temp_key' // ç”¨æˆ·éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„API key
                }
            }
        ];

        // ç›‘å¬æ¥è‡ªFigmaæ’ä»¶çš„æ¶ˆæ¯
        window.addEventListener('message', async (event) => {
            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', event.data);
            
            if (event.data.type === 'API_REQUEST') {
                try {
                    // æ£€æŸ¥æ˜¯æ–°æ ¼å¼è¿˜æ˜¯æ—§æ ¼å¼
                    if (event.data.apiUrl) {
                        // æ–°æ ¼å¼ï¼šç›´æ¥ä»event.dataè§£æ„
                        const { apiUrl, headers, body } = event.data;
                        const result = await makeAPIRequestDirect(apiUrl, 'POST', headers, JSON.stringify(body), 'anthropic');
                        sendResponse('API_RESPONSE', { success: true, data: result });
                    } else if (event.data.payload) {
                        // æ—§æ ¼å¼ï¼šä½¿ç”¨payload
                        const result = await makeAPIRequest(event.data.payload);
                        sendResponse('API_RESPONSE', { success: true, data: result });
                    } else {
                        throw new Error('æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®ï¼šç¼ºå°‘apiUrlæˆ–payload');
                    }
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
                    sendResponse('API_RESPONSE', { 
                        success: false, 
                        error: error.message 
                    });
                }
            }
        });

        // å‘é€å“åº”å›Figmaæ’ä»¶
        function sendResponse(type, payload) {
            // ç›´æ¥å‘é€æ ¼å¼ï¼ˆç¬¦åˆæ’ä»¶æœŸæœ›ï¼‰
            parent.postMessage({
                type: type,
                success: payload.success,
                data: payload.data,
                error: payload.error
            }, "*");
        }

        // æ–°çš„ç›´æ¥APIè¯·æ±‚å‡½æ•°ï¼ˆç”¨äºæ–°æ¶ˆæ¯æ ¼å¼ï¼‰
        async function makeAPIRequestDirect(url, method, headers, body, provider) {
            console.log('ğŸš€ å¼€å§‹APIè¯·æ±‚:', { url, provider });
            
            // å¦‚æœæ˜¯OpenAIï¼Œç›´æ¥è¯·æ±‚ï¼ˆä¸éœ€è¦ä»£ç†ï¼‰
            if (provider === 'openai') {
                return await directAPIRequest(url, method, headers, body);
            }
            
            // å¦‚æœæ˜¯Anthropicï¼Œä½¿ç”¨ä»£ç†
            let lastError = null;
            
            for (const proxy of CORS_PROXIES) {
                try {
                    console.log(`ğŸ”„ å°è¯•ä»£ç†: ${proxy.name}`);
                    
                    const proxyUrl = proxy.url + url;
                    const proxyHeaders = {
                        ...headers,
                        ...proxy.headers
                    };
                    
                    const response = await fetch(proxyUrl, {
                        method,
                        headers: proxyHeaders,
                        body: method !== 'GET' ? body : undefined
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`âœ… ${proxy.name} æˆåŠŸ!`);
                        return data;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ ${proxy.name} å¤±è´¥:`, error.message);
                    lastError = error;
                    continue;
                }
            }
            
            throw new Error(`æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥äº†ã€‚æœ€åé”™è¯¯: ${lastError?.message}`);
        }

        // ä½¿ç”¨å¤šä¸ªä»£ç†å°è¯•APIè¯·æ±‚ï¼ˆç”¨äºæ—§æ¶ˆæ¯æ ¼å¼ï¼‰
        async function makeAPIRequest(config) {
            const { url, method, headers, body, provider } = config;
            
            console.log('ğŸš€ å¼€å§‹APIè¯·æ±‚:', { url, provider });
            
            // å¦‚æœæ˜¯OpenAIï¼Œç›´æ¥è¯·æ±‚ï¼ˆä¸éœ€è¦ä»£ç†ï¼‰
            if (provider === 'openai') {
                return await directAPIRequest(url, method, headers, body);
            }
            
            // å¦‚æœæ˜¯Anthropicï¼Œä½¿ç”¨ä»£ç†
            let lastError = null;
            
            for (const proxy of CORS_PROXIES) {
                try {
                    console.log(`ğŸ”„ å°è¯•ä»£ç†: ${proxy.name}`);
                    
                    const proxyUrl = proxy.url + url;
                    const proxyHeaders = {
                        ...headers,
                        ...proxy.headers
                    };
                    
                    const response = await fetch(proxyUrl, {
                        method,
                        headers: proxyHeaders,
                        body: method !== 'GET' ? body : undefined
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`âœ… ${proxy.name} æˆåŠŸ!`);
                        return data;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ ${proxy.name} å¤±è´¥:`, error.message);
                    lastError = error;
                    continue;
                }
            }
            
            throw new Error(`æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥äº†ã€‚æœ€åé”™è¯¯: ${lastError?.message}`);
        }

        // ç›´æ¥APIè¯·æ±‚ï¼ˆç”¨äºOpenAIï¼‰
        async function directAPIRequest(url, method, headers, body) {
            const response = await fetch(url, {
                method,
                headers,
                body: method !== 'GET' ? body : undefined
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        // é¡µé¢åŠ è½½å®Œæˆåé€šçŸ¥æ’ä»¶
        window.addEventListener('load', () => {
            console.log('âœ… APIä»£ç†å‡†å¤‡å°±ç»ª');
            parent.postMessage({
                type: 'PROXY_READY',
                message: 'APIä»£ç†å·²å‡†å¤‡å°±ç»ª'
            }, "*");
        });
    </script>
</body>
</html> 
